<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{background:#2C2C2C}
:root{--bg:#2C2C2C;--surface:#383838;--border:#4A4A4A;--text:#E0E0E0;--muted:#999;--dim:#666;--push:#7EF7F0;--push-fg:#0A0A0A;--pull:#7A8DFF;--success:#7EF7F0;--warn:#E8C36A;--err:#FF6B6B}
body{background:var(--bg);color:var(--text);font-family:"Inter",system-ui,sans-serif;font-size:11px;line-height:1.2;width:270px;height:100vh;display:flex;flex-direction:column;overflow:hidden;-webkit-font-smoothing:antialiased}

/* header */
.hbg{flex-shrink:0;background:var(--bg);border-bottom:1px solid var(--border)}
header{padding:12px 16px;display:flex;align-items:center;gap:6px}
.bname{font-size:13px;font-weight:700;color:var(--text)}
.sdot{width:6px;height:6px;border-radius:50%;background:var(--success);flex-shrink:0}
.sdot.run{background:var(--pull);animation:pul 1s infinite}
.sdot.err{background:var(--err)}
@keyframes pul{0%,100%{opacity:1}50%{opacity:.3}}
.stxt{font-size:10px;color:var(--dim)}

/* context banner - centered */
.ctx{padding:6px 16px;font-size:10px;color:var(--pull);background:rgba(122,141,255,.08);border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;gap:5px}
.cdot{width:6px;height:6px;border-radius:50%;background:var(--pull);flex-shrink:0}

/* sections */
.sec{padding:14px 16px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column;gap:8px}
.slbl{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--muted)}
.sdesc{font-size:10px;color:var(--dim);line-height:1.45}

/* buttons - outline by default, solid on hover */
button{cursor:pointer;border:1px solid var(--push);border-radius:8px;font-family:inherit;font-size:13px;font-weight:700;padding:12px 16px;width:100%;display:flex;align-items:center;justify-content:center;gap:6px;background:transparent;color:var(--text);position:relative;overflow:hidden;transition:background 94ms ease-in-out,color 94ms ease-in-out,box-shadow 94ms ease-in-out,transform 94ms ease-in-out}
button:hover:not(:disabled){background:var(--push);color:var(--push-fg);box-shadow:0 0 20px rgba(126,247,240,.3),0 0 40px rgba(126,247,240,.12)}
button:active:not(:disabled){transform:scale(.97)}
button:disabled{opacity:.35;cursor:not-allowed}
.bicon{font-size:15px;font-weight:400;line-height:1}

/* log */
.lhdr{padding:6px 16px;font-size:10px;font-weight:600;color:var(--dim);text-transform:uppercase;letter-spacing:.06em;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;justify-content:space-between;align-items:center}
.lclr{font-size:9px;color:var(--dim);cursor:pointer;text-transform:none;letter-spacing:0;font-weight:400}
.lclr:hover{color:var(--muted)}
.log{flex:1;min-height:80px;overflow-y:auto;padding:8px 16px;display:flex;flex-direction:column;gap:1px;font-family:"SF Mono","Fira Code",monospace;font-size:9px}
.e{color:var(--dim)}.e.info{color:var(--muted)}.e.warn{color:var(--warn)}.e.success{color:var(--success)}.e.error{color:var(--err)}

/* footer */
footer{padding:8px 16px;border-top:1px solid var(--border);font-size:9px;color:var(--dim);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.fr{display:flex;align-items:center;gap:10px}
.fl{color:var(--dim);text-decoration:none;font-size:9px}
.fl:hover{color:var(--muted)}
</style></head>
<body>
<div class="hbg"><header>
<span class="bname">StudioFlow</span>
<span class="sdot" id="dot"></span>
<span class="stxt" id="status">Ready</span>
</header></div>
<div class="ctx" id="ctx"><span class="cdot"></span><span id="ctxTxt">Target: entire page</span></div>
<div class="sec">
<div class="slbl">Code → Figma</div>
<div class="sdesc">Rebuild all screen frames and token variables on this canvas from code.</div>
<button id="runAll"><span class="bicon">⟳</span> Sync to Figma</button>
</div>
<div class="sec">
<div class="slbl">Variables</div>
<div class="sdesc">Bind all variables + text styles to existing nodes (use after MCP build).</div>
<button id="bindBtn"><span class="bicon">⌁</span> Bind Variables</button>
</div>
<div class="sec">
<div class="slbl">Figma → Code</div>
<div class="sdesc">Send your design changes back to the codebase in one step.</div>
<button id="exportBtn"><span class="bicon">⟳</span> Sync to Code</button>
</div>
<div class="lhdr"><span>Log</span><span class="lclr" id="clearLog">Clear</span></div>
<div class="log" id="log"><div class="e info">Awaiting action…</div></div>
<footer>
<span>v4.0.0</span>
<div class="fr">
<a class="fl" href="https://github.com/becktothefuture/studioflow#readme" target="_blank">Docs ↗</a>
<a class="fl" href="https://github.com/becktothefuture/studioflow" target="_blank">GitHub ↗</a>
</div>
</footer>
<script>
var L=document.getElementById('log'),S=document.getElementById('status'),D=document.getElementById('dot'),CT=document.getElementById('ctxTxt');
var rBtn=document.getElementById('runAll'),eBtn=document.getElementById('exportBtn'),bBtn=document.getElementById('bindBtn'),cBtn=document.getElementById('clearLog');
var btns=[rBtn,eBtn,bBtn],ws=null,bc=false;
function conn(){try{ws=new WebSocket('ws://localhost:9801');ws.onopen=function(){bc=true;al('Bridge connected','success')};ws.onmessage=function(e){try{var m=JSON.parse(e.data);if(m.type==='log')al(m.text,m.level||'info');if(m.type==='done')dn(m.text||'Sync complete');if(m.type==='error')er(m.text||'Bridge error')}catch(x){al(e.data,'info')}};ws.onclose=function(){bc=false;setTimeout(conn,5000)};ws.onerror=function(){ws.close()}}catch(x){setTimeout(conn,5000)}}
conn();
function al(t,l){var d=document.createElement('div');d.className='e '+(l||'info');d.textContent=t;L.appendChild(d);L.scrollTop=L.scrollHeight}
function rn(m){btns.forEach(function(b){b.disabled=true});D.className='sdot run';S.textContent=m;al('▶ '+m)}
function dn(m){btns.forEach(function(b){b.disabled=false});D.className='sdot';S.textContent='Ready';al('✓ '+m,'success')}
function er(m){btns.forEach(function(b){b.disabled=false});D.className='sdot err';S.textContent='Error';al('✗ '+m,'error')}
function post(t){parent.postMessage({pluginMessage:{type:t}},'*')}
rBtn.addEventListener('click',function(){rn('Syncing…');post('run-all')});
bBtn.addEventListener('click',function(){rn('Binding…');post('bind-variables')});
eBtn.addEventListener('click',function(){rn('Syncing…');post('export-canvas')});
cBtn.addEventListener('click',function(){L.innerHTML='<div class="e info">Log cleared.</div>'});
window.onmessage=function(ev){
var m=ev.data.pluginMessage;if(!m)return;
switch(m.type){
case'log':al(m.text,m.level||'info');break;
case'frames-done':(m.results||[]).forEach(function(r){al('  "'+r.name+'" '+r.width+'px → '+r.id,'success')});dn('Frames created');break;
case'bind-done':al('  '+m.stats.bound+' bindings · '+m.stats.visited+' nodes','success');dn('Variables bound');break;
case'all-done':(m.results||[]).forEach(function(r){al('  "'+r.name+'" '+r.width+'px → '+r.id,'success')});if(m.stats)al('  '+m.stats.bound+' variable bindings','success');dn('Sync to Figma complete');break;
case'export-done':if(m.json){if(bc&&ws&&ws.readyState===1){ws.send(JSON.stringify({type:'sync-to-code',payload:m.json}));al('Payload sent to bridge…','info')}else{navigator.clipboard.writeText(m.json).then(function(){dn('Copied to clipboard');al('Paste into handoff/canvas-to-code.json','warn')}).catch(function(){al('Clipboard failed','warn');dn('Sync ready')})}}break;
case'selection-update':if(m.selectedFrames&&m.selectedFrames.length>0)CT.textContent='Target: '+m.selectedFrames.join(', ');else if(m.screenName)CT.textContent='Target: '+m.screenName;else if(m.hasScreens)CT.textContent='Target: all screen frames';else CT.textContent='Target: entire page';break;
case'error':er(m.text);break;
}};
</script>
</body></html>
